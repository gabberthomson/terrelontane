<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Terre Lontane - Assistente</title>

  <!-- Bootstrap (solo CSS) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      --bg-overlay: rgba(0, 0, 0, 0.35);
      --panel: rgba(255, 255, 255, 0.92);
      --bubble-ai: rgba(255, 255, 255, 0.96);
      --bubble-user: rgba(13, 110, 253, 0.10);
      --border: rgba(0,0,0,0.10);
    }

    body {
      min-height: 100vh;
      background: #0b1220;
      /* Sfondo provvisorio: lo cambieremo dopo. */
      background-image:
        linear-gradient(var(--bg-overlay), var(--bg-overlay)),
        radial-gradient(circle at 20% 10%, rgba(255,255,255,0.10), transparent 35%),
        radial-gradient(circle at 80% 30%, rgba(255,255,255,0.08), transparent 40%),
        radial-gradient(circle at 40% 90%, rgba(255,255,255,0.06), transparent 45%);
      background-size: cover;
      background-position: center;
    }

    .app-shell {
      max-width: 980px;
      margin: 0 auto;
      padding: 16px;
    }

    .topbar {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 10px 12px;
      backdrop-filter: blur(6px);
    }

    .chat-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      backdrop-filter: blur(6px);
      overflow: hidden;
    }

    .chat-scroll {
      height: calc(100vh - 210px);
      min-height: 420px;
      overflow-y: auto;
      padding: 14px 14px 8px 14px;
    }

    @media (max-width: 576px) {
      .chat-scroll {
        height: calc(100vh - 240px);
        min-height: 420px;
      }
    }

    .msg-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }

    .msg-row.ai { justify-content: flex-start; }
    .msg-row.user { justify-content: flex-end; }

    .bubble {
      max-width: min(780px, 92%);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 10px 12px;
      line-height: 1.35;
      white-space: pre-wrap; /* mantiene i \n */
      word-break: break-word;
    }

    .bubble.ai {
      background: var(--bubble-ai);
    }

    .bubble.user {
      background: var(--bubble-user);
      font-style: italic;
    }

    .meta {
      opacity: 0.6;
      font-size: 12px;
      margin-top: 4px;
    }

    .composer {
      padding: 12px;
      border-top: 1px solid var(--border);
      background: rgba(255,255,255,0.96);
    }

    textarea.form-control {
      resize: none;
      min-height: 54px;
      max-height: 160px;
    }

    .hint {
      font-size: 12px;
      opacity: 0.70;
    }

    .spinner {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(0,0,0,0.15);
      border-top-color: rgba(0,0,0,0.55);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: -3px;
      margin-right: 6px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>

<body>
  <div class="app-shell">
    <!-- Top bar -->
    <div class="topbar d-flex align-items-center justify-content-between gap-2 mb-3">
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <strong>Terre Lontane</strong>
        <span class="text-muted">Assistente</span>
        <a id="manualLink" class="btn btn-sm btn-outline-secondary" href="./risorse_terre_lontane.pdf" target="_blank" rel="noopener">
          Scarica risorse del gioco (PDF)
        </a>
      </div>

      <div class="d-flex align-items-center gap-2">
        <button id="btnNew" class="btn btn-sm btn-primary">Nuova chat</button>
        <button id="btnReset" class="btn btn-sm btn-outline-danger">Reset chat</button>
      </div>
    </div>

    <!-- Chat -->
    <div class="chat-card">
      <div id="chat" class="chat-scroll">
        <!-- Messaggi renderizzati qui -->
      </div>

      <!-- Composer -->
      <div class="composer">
        <div class="input-group">
          <textarea id="input" class="form-control" placeholder="Scrivi qui..."></textarea>
          <button id="btnSend" class="btn btn-success px-3">Invia</button>
        </div>
        <div class="d-flex justify-content-between mt-2">
          <div class="hint">Invio = invia • Ctrl+Invio = a capo</div>
          <div id="status" class="hint text-end"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // CONFIG
    // =========================
    const WORKER_BASE_URL = "https://terrelontane.gabbriellini.workers.dev"; // <-- CAMBIA QUI
    const STORAGE_KEY = "tl_session_id_v1";

    // =========================
    // SYSTEM PROMPT (il tuo)
    // =========================
    const SYSTEM_PROMPT = `Sei l’assistente ufficiale del gioco di ruolo “Terre Lontane”.

Per OGNI domanda dell’utente devi seguire questo processo:

Determina la modalità della domanda:

REGOLA → chiarimenti su regole, meccaniche, abilità, oggetti, combattimento, magie, tiri, mostri già esistenti.

IDEE → spunti creativi: avventure, ambientazioni, PNG, nuovi mostri, oggetti inventati.

MISTA → una parte di regole + una parte creativa.

Usa SEMPRE il tool file_search sul manuale di “Terre Lontane” prima di rispondere.

MODALITÀ REGOLA:

Rispondi SOLO usando informazioni presenti negli estratti recuperati con file_search.

NON inventare regole, numeri, eccezioni o interpretazioni.

Se non trovi la risposta negli estratti, dì:
“Questa informazione non è presente nel manuale di Terre Lontane”.

NON proporre house rule.

MODALITÀ IDEE:

Usa gli estratti come canone (tono, ambientazione, meccaniche).

Poi proponi idee pratiche e subito giocabili.

Se fai assunzioni non presenti, dichiaralo.

MODALITÀ MISTA:

Dividi in “Regole” (solo manuale) e “Idee” (creative ma coerenti).

Inizia SEMPRE indicando la modalità: “Modalità: REGOLA / IDEE / MISTA”.`;

    // =========================
    // DOM
    // =========================
    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const statusEl = document.getElementById("status");
    const btnSend = document.getElementById("btnSend");
    const btnNew = document.getElementById("btnNew");
    const btnReset = document.getElementById("btnReset");

    // =========================
    // STATE
    // =========================
    let sessionId = localStorage.getItem(STORAGE_KEY) || null;
    let isBusy = false;

    // =========================
    // UI helpers
    // =========================
    function setBusy(busy, text) {
      isBusy = busy;
      btnSend.disabled = busy;
      btnNew.disabled = busy;
      btnReset.disabled = busy;
      inputEl.disabled = busy;

      statusEl.textContent = text || "";
    }

    function scrollToBottom() {
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function escapeHtml(str) {
      return str.replace(/[&<>"']/g, (m) => ({
        "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#039;"
      }[m]));
    }

    function addMessage(role, text) {
      const row = document.createElement("div");
      row.className = `msg-row ${role}`;

      const bubble = document.createElement("div");
      bubble.className = `bubble ${role}`;
      // rendering semplice: testo in chiaro (niente textbox)
      bubble.innerHTML = escapeHtml(text);

      row.appendChild(bubble);
      chatEl.appendChild(row);
      scrollToBottom();
    }

    function addThinking() {
      const row = document.createElement("div");
      row.className = "msg-row ai";
      row.id = "thinking-row";

      const bubble = document.createElement("div");
      bubble.className = "bubble ai";
      bubble.innerHTML = `<span class="spinner"></span>Sto pensando...`;

      row.appendChild(bubble);
      chatEl.appendChild(row);
      scrollToBottom();
    }

    function removeThinking() {
      const el = document.getElementById("thinking-row");
      if (el) el.remove();
    }

    // =========================
    // API
    // =========================
    async function api(path, body) {
      const res = await fetch(`${WORKER_BASE_URL}${path}`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(body || {}),
      });
      const txt = await res.text();
      let json = null;
      try { json = JSON.parse(txt); } catch { /* ignore */ }
      if (!res.ok) {
        const detail = json?.detail || json?.error || txt || `HTTP ${res.status}`;
        throw new Error(detail);
      }
      return json ?? {};
    }

    async function ensureSession() {
      if (sessionId) return sessionId;
      const out = await api("/api/session/new", {});
      sessionId = out.sessionId;
      localStorage.setItem(STORAGE_KEY, sessionId);
      return sessionId;
    }

    async function newSession() {
      const out = await api("/api/session/new", {});
      sessionId = out.sessionId;
      localStorage.setItem(STORAGE_KEY, sessionId);
      chatEl.innerHTML = "";
      addMessage("ai", "Nuova chat avviata. Dimmi pure.");
    }

    async function resetSession() {
      if (!sessionId) {
        // se non c'è sessione, equivale a nuova
        return newSession();
      }
      await api(`/api/session/${encodeURIComponent(sessionId)}/reset`, {});
      chatEl.innerHTML = "";
      addMessage("ai", "Chat resettata. Dimmi pure.");
    }

    async function sendMessage() {
      const text = (inputEl.value || "").trim();
      if (!text || isBusy) return;

      setBusy(true, "");
      addMessage("user", text);
      inputEl.value = "";
      addThinking();

      try {
        const sid = await ensureSession();
        const out = await api(`/api/session/${encodeURIComponent(sid)}/chat`, {
          message: text,
          systemPrompt: SYSTEM_PROMPT,
        });
        removeThinking();
        addMessage("ai", out.text || "(risposta vuota)");
      } catch (e) {
        removeThinking();
        addMessage("ai", `Errore: ${String(e.message || e)}`);
      } finally {
        setBusy(false, "");
        inputEl.focus();
      }
    }

    // =========================
    // Events
    // =========================
    btnSend.addEventListener("click", sendMessage);

    inputEl.addEventListener("keydown", (ev) => {
      // Ctrl+Enter: newline
      if (ev.key === "Enter" && ev.ctrlKey) {
        // lascia comportamento naturale (a capo)
        return;
      }

      // Enter: send (senza shift, senza ctrl)
      if (ev.key === "Enter" && !ev.ctrlKey && !ev.shiftKey) {
        ev.preventDefault();
        sendMessage();
      }
    });

    btnNew.addEventListener("click", async () => {
      if (isBusy) return;
      setBusy(true, "Creo nuova chat...");
      try {
        await newSession();
      } catch (e) {
        addMessage("ai", `Errore: ${String(e.message || e)}`);
      } finally {
        setBusy(false, "");
        inputEl.focus();
      }
    });

    btnReset.addEventListener("click", async () => {
      if (isBusy) return;
      setBusy(true, "Reset in corso...");
      try {
        await resetSession();
      } catch (e) {
        addMessage("ai", `Errore: ${String(e.message || e)}`);
      } finally {
        setBusy(false, "");
        inputEl.focus();
      }
    });

    // Init UI
    (function boot() {
      addMessage("ai", "Pronto. Fai una domanda su Terre Lontane.");
      inputEl.focus();
    })();
  </script>
</body>
</html>
