<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Terre Lontane Assistente</title>

  <!-- Markdown + sanitize -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js" defer></script>

  <style>
    :root{
      --bg-overlay: rgba(10,14,22,.72);
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --accent: #38bdf8;
      --border: rgba(255,255,255,.14);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }

    html, body { height: 100%; margin: 0; }
    body{
      min-height: 100svh;
      background:
        linear-gradient(var(--bg-overlay), var(--bg-overlay)),
        url("bg-placeholder.jpg") center/cover no-repeat fixed;
      color: var(--text);
      font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    @supports (height: 100dvh){
      body{ min-height: 100dvh; }
    }

    .app{
      min-height: 100svh;
      display: flex;
      justify-content: center;
      padding: 14px;
      padding-bottom: calc(14px + env(safe-area-inset-bottom));
      box-sizing: border-box;
    }
    @supports (height: 100dvh){
      .app{ min-height: 100dvh; }
    }

    .shell{
      width: 100%;
      max-width: 980px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    header{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 10px 12px;
      backdrop-filter: blur(10px);
    }
    .brand{
      display:flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }
    .brand strong{ font-size: 14px; }
    .brand a{
      color: var(--muted);
      text-decoration: none;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
    }
    .actions{ display:flex; gap: 8px; flex-wrap: wrap; }

    .btn{
      appearance: none;
      border: 1px solid var(--border);
      background: var(--panel2);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(0,0,0,.22);
      transition: transform .06s ease, background .12s ease;
      font-weight: 600;
      font-size: 13px;
    }
    .btn:hover{ background: rgba(255,255,255,.14); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border-color: rgba(56,189,248,.35); }
    .btn.danger{ border-color: rgba(248,113,113,.35); }

    .chat{
      flex: 1;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow: auto;
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      scroll-behavior: smooth;
    }

    .row{ display:flex; }
    .row.user{ justify-content: flex-end; }
    .row.ai{ justify-content: flex-start; }

    .bubble{
      max-width: min(780px, 92%);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255,255,255,.08);
      box-shadow: 0 8px 16px rgba(0,0,0,.22);
      word-wrap: break-word;
      overflow-wrap: anywhere;
    }
    .bubble.user{
      background: rgba(56,189,248,.12);
      border-color: rgba(56,189,248,.26);
      font-style: italic;
    }
    .bubble.ai{
      background: rgba(255,255,255,.08);
    }

    /* Markdown */
    .md :first-child{ margin-top: 0; }
    .md :last-child{ margin-bottom: 0; }
    .md p{ margin: 0 0 10px; }
    .md pre{
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 12px;
      padding: 10px;
      overflow:auto;
    }
    .md code{
      background: rgba(0,0,0,.25);
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.14);
    }
    .md a{ color: var(--accent); }
    .md ul, .md ol{ margin: 6px 0 10px 18px; }
    .md blockquote{
      margin: 6px 0 10px;
      padding-left: 10px;
      border-left: 3px solid rgba(56,189,248,.45);
      color: var(--muted);
    }

    .composer{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      padding: 10px;
      display:flex;
      flex-direction: column;
      gap: 8px;
      position: sticky;
      bottom: 0;
    }

    textarea{
      width: 100%;
      min-height: 46px;
      max-height: 180px;
      resize: none;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding: 10px 10px;
      box-sizing: border-box;
      outline: none;
      font: 14px/1.35 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .composerRow{
      display:flex;
      gap: 8px;
      align-items: flex-end;
    }
    .hint{
      font-size: 12px;
      color: var(--muted);
      display:flex;
      justify-content: space-between;
      gap: 10px;
    }
    .status{ white-space: nowrap; }

    /* Evita che su mobile l’input venga “tagliato” */
    @media (max-width: 640px){
      .shell{ gap: 10px; }
      header{ padding: 10px; }
      .chat{ padding: 10px; }
      .bubble{ max-width: 94%; }
      .brand a{ max-width: 60vw; }
    }
  </style>
</head>

<body>
  <div class="app">
    <div class="shell">
      <header>
        <div class="brand">
          <strong>Terre Lontane Assistente</strong>
          <a href="#" target="_blank" rel="noreferrer">PDF (placeholder – privato)</a>
        </div>
        <div class="actions">
          <button class="btn danger" id="btnNew">Nuova chat</button>
        </div>
      </header>

      <div class="chat" id="chat" aria-live="polite"></div>

      <div class="composer">
        <div class="composerRow">
          <textarea id="input" placeholder="Scrivi qui… (Invio = invia, Ctrl+Invio = a capo)"></textarea>
          <button class="btn primary" id="btnSend">Invia</button>
        </div>
        <div class="hint">
          <div>Enter = invia • Ctrl+Enter = newline</div>
          <div class="status" id="status"></div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // =========================
  // CONFIG
  // =========================
  const API_BASE = "https://terrelontane.gabbriellini.workers.dev"; // <-- CAMBIA QUI se necessario
  const LS_KEY = "tl_sessionId";

  // =========================
  // DOM
  // =========================
  const chatEl = document.getElementById("chat");
  const inputEl = document.getElementById("input");
  const btnSend = document.getElementById("btnSend");
  const btnNew = document.getElementById("btnNew");
  const statusEl = document.getElementById("status");

  let sessionId = localStorage.getItem(LS_KEY) || "";
  let busy = false;

  // =========================
  // Helpers
  // =========================
  function setStatus(msg) { statusEl.textContent = msg || ""; }

  function scrollToBottom() {
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function renderMarkdown(text) {
    const raw = (text || "").toString();
    if (!window.marked) return escapeHtml(raw).replace(/\n/g, "<br>");
    const html = marked.parse(raw, { breaks: true });
    return window.DOMPurify ? DOMPurify.sanitize(html) : html;
  }

  function escapeHtml(s) {
    return (s || "").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function addMessage(role, text) {
    const row = document.createElement("div");
    row.className = "row " + role;

    const bubble = document.createElement("div");
    bubble.className = "bubble " + role;

    if (role === "ai") {
      const md = document.createElement("div");
      md.className = "md";
      md.innerHTML = renderMarkdown(text);
      bubble.appendChild(md);
    } else {
      bubble.textContent = (text ?? "").toString();
    }

    row.appendChild(bubble);
    chatEl.appendChild(row);
    scrollToBottom();
    return row;
  }

  async function postJson(path, payload) {
    const res = await fetch(API_BASE + path, {
      method: "POST",
      headers: { "content-type": "application/json" },
      body: JSON.stringify(payload || {})
    });
    const txt = await res.text().catch(() => "");
    let json;
    try { json = txt ? JSON.parse(txt) : {}; } catch { json = { raw: txt }; }
    if (!res.ok) {
      const msg = json?.error || ("HTTP " + res.status);
      throw new Error(msg);
    }
    return json;
  }

  async function ensureSession() {
    if (sessionId) return sessionId;
    const out = await postJson("/api/session/new", {});
    sessionId = (out.sessionId || "").toString();
    if (!sessionId) throw new Error("sessionId mancante");
    localStorage.setItem(LS_KEY, sessionId);
    return sessionId;
  }

  async function loadHistoryIfAny() {
    if (!sessionId) return false;
    try {
      const out = await postJson("/api/session/history", { sessionId, limit: 160 });
      const msgs = Array.isArray(out.messages) ? out.messages : [];
      if (msgs.length === 0) return false;

      chatEl.innerHTML = "";
      for (const m of msgs) {
        if (m.role === "user") addMessage("user", m.text || "");
        else addMessage("ai", m.text || "");
      }
      scrollToBottom();
      return true;
    } catch (e) {
      // sessionId non valido o scaduto: pulisci e riparti
      localStorage.removeItem(LS_KEY);
      sessionId = "";
      return false;
    }
  }

  async function resetSessionUiAndBackend() {
    if (!sessionId) {
      chatEl.innerHTML = "";
      addMessage("ai", "Pronto. Fai una domanda su Terre Lontane.");
      return;
    }
    await postJson("/api/session/reset", { sessionId });
    chatEl.innerHTML = "";
    addMessage("ai", "Nuova chat avviata. Fai una domanda su Terre Lontane.");
  }

  function setBusy(isBusy, msg) {
    busy = isBusy;
    btnSend.disabled = isBusy;
    btnNew.disabled = isBusy;
    setStatus(msg || (isBusy ? "…" : ""));
  }

  async function sendMessage() {
    const raw = inputEl.value || "";
    const text = raw.trim();
    if (!text || busy) return;

    setBusy(true, "Invio…");

    // mostra subito user
    addMessage("user", raw.trimEnd());
    inputEl.value = "";

    // Chiudi tastiera su mobile (evita che si riapra)
    const isMobileLike = matchMedia("(pointer: coarse)").matches;
    if (isMobileLike) inputEl.blur();

    try {
      const sid = await ensureSession();
      setStatus("Risposta…");
      const out = await postJson("/api/chat", {
        sessionId: sid,
        message: text,
      });

      addMessage("ai", out.text || "(risposta vuota)");
    } catch (e) {
      addMessage("ai", "Errore: " + String(e.message || e));
    } finally {
      setBusy(false, "");
      if (!isMobileLike) inputEl.focus();
    }
  }

  // =========================
  // Events
  // =========================
  btnSend.addEventListener("click", sendMessage);

  inputEl.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      if (e.ctrlKey || e.metaKey) {
        // newline
        return;
      }
      e.preventDefault();
      sendMessage();
    }
  });

  btnNew.addEventListener("click", async () => {
    if (busy) return;
    setBusy(true, "Reset…");
    try {
      await resetSessionUiAndBackend();
    } catch (e) {
      addMessage("ai", "Errore reset: " + String(e.message || e));
    } finally {
      setBusy(false, "");
      inputEl.focus();
    }
  });

  // =========================
  // Boot
  // =========================
  (async () => {
    const loaded = await loadHistoryIfAny();
    if (!loaded) addMessage("ai", "Pronto. Fai una domanda su Terre Lontane.");
    inputEl.focus();
  })();

})();
</script>
</body>
</html>